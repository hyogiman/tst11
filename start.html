<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶”ë¦¬ ê²Œì„</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ•µï¸</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ì—­í•  ì¹´ë“œ */
        .role-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .role-card.detective {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .role-card.criminal {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .role-card.merchant {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .role-title {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .role-description {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .secret-code {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px dashed rgba(255,255,255,0.5);
        }

        .secret-code-label {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .secret-code-value {
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: 3px;
            text-align: center;
        }

        /* ì½”ë“œ ì…ë ¥ í™”ë©´ */
        .code-input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .code-input-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        /* ê²°ê³¼ ëª©ë¡ */
        .result-list {
            margin-top: 20px;
        }

        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .result-item:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .result-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .result-item-subtitle {
            font-size: 0.9em;
            color: #666;
        }

        .result-item-value {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            color: #27ae60;
        }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 100% !important;
            max-width: 400px !important;
            background: white !important;
            border-top: 1px solid #e9ecef !important;
            display: flex !important;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
            z-index: 1000 !important;
            visibility: visible !important;
        }

        .nav-item {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            background: none;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .nav-item:hover {
            background: #f8f9fa;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .nav-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .nav-item.disabled:hover {
            background: none;
        }

        /* ê³µê²© ë²„íŠ¼ */
        .attack-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .attack-btn:hover {
            background: #c0392b;
        }

        .nav-icon {
            font-size: 1.2em;
            margin-bottom: 3px;
            display: block;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .container {
                width: 100%;
                border-radius: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .nav-item {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•µï¸ ì¶”ë¦¬ ê²Œì„</h1>
            <p class="subtitle">íƒì •, ë²”ì¸, ìƒì¸ì˜ ì‹¬ë¦¬ì „</p>
        </div>

        <div class="content">
            <!-- ë¡œê·¸ì¸ í™”ë©´ -->
            <div class="screen active" id="loginScreen">
                <div class="login-form">
                    <h2 style="text-align: center; margin-bottom: 20px;">ê²Œì„ ì°¸ê°€</h2>
                    
                    <div class="form-group">
                        <label for="loginCode">ë¡œê·¸ì¸ ì½”ë“œ</label>
                        <input type="text" id="loginCode" placeholder="ì˜ë¬¸+ìˆ«ì 4ìë¦¬ ì…ë ¥" maxlength="4" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="playerName">ì„±ëª…</label>
                        <input type="text" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <div class="form-group">
                        <label for="playerPosition">ì§ìœ„</label>
                        <input type="text" id="playerPosition" placeholder="ì§ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <button class="btn" id="loginButton">ê²Œì„ ì‹œì‘</button>
                </div>

                <div class="loading" id="loginLoading">
                    <div class="spinner"></div>
                    <p>ë¡œê·¸ì¸ ì¤‘...</p>
                </div>
            </div>

            <!-- í™ˆ í™”ë©´ -->
            <div class="screen" id="homeScreen">
                <div id="roleCard" class="role-card">
                    <!-- ì—­í•  ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="status-message" id="gameStatus">
                    ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ê³¼ ìƒí˜¸ì‘ìš©í•˜ë©° ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì„¸ìš”!
                </div>
            </div>

            <!-- ì—­í• /ì‹œí¬ë¦¿ ì½”ë“œ í™”ë©´ -->
            <div class="screen" id="roleScreen">
                <h2 style="margin-bottom: 20px;">ë‚´ ì •ë³´</h2>
                
                <div class="code-input-section">
                    <div class="code-input-title">ë‚´ ì—­í• </div>
                    <div id="myRole" style="font-size: 1.2em; font-weight: 600; color: #667eea;">-</div>
                </div>

                <div class="code-input-section">
                    <div class="code-input-title">ë‚˜ì˜ ì‹œí¬ë¦¿ ì½”ë“œ</div>
                    <div id="mySecretCode" style="font-size: 2em; font-weight: 700; text-align: center; letter-spacing: 3px; color: #e74c3c;">-</div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        ìƒí˜¸ì‘ìš© ê²Œì„ì—ì„œ ì§ˆ ê²½ìš° ìƒëŒ€ì—ê²Œ ì´ ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.
                    </p>
                </div>
            </div>

            <!-- ì½”ë“œ ì…ë ¥ í™”ë©´ -->
            <div class="screen" id="codeInputScreen">
                <h2 style="margin-bottom: 20px;">ì‹œí¬ë¦¿ ì½”ë“œ ì…ë ¥</h2>
                
                <div class="code-input-section">
                    <div class="code-input-title">ìƒëŒ€ë°©ì˜ ì‹œí¬ë¦¿ ì½”ë“œ</div>
                    <div class="form-group">
                        <input type="text" id="targetCode" placeholder="4ìë¦¬ ì½”ë“œ ì…ë ¥" maxlength="4" style="text-transform: uppercase;">
                    </div>
                    <button class="btn" id="submitCodeButton">ì½”ë“œ í™•ì¸</button>
                </div>

                <div class="loading" id="codeLoading">
                    <div class="spinner"></div>
                    <p>ì½”ë“œ ì²˜ë¦¬ ì¤‘...</p>
                </div>

                <div id="codeResult" style="margin-top: 20px;"></div>
            </div>

            <!-- ê²°ê³¼ í™”ë©´ -->
            <div class="screen" id="resultScreen">
                <h2 style="margin-bottom: 20px;" id="resultTitle">ë‚´ ê²°ê³¼</h2>
                
                <div id="resultContent">
                    <!-- ì—­í• ë³„ ê²°ê³¼ê°€ ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bottom-nav" id="bottomNav">
            <button class="nav-item active" id="homeNavBtn">
                <span class="nav-icon">ğŸ </span>
                í™ˆ
            </button>
            <button class="nav-item disabled" id="roleNavBtn">
                <span class="nav-icon">ğŸ‘¤</span>
                ì—­í• /S.C
            </button>
            <button class="nav-item disabled" id="codeInputNavBtn">
                <span class="nav-icon">ğŸ”¢</span>
                ì½”ë“œì…ë ¥
            </button>
            <button class="nav-item disabled" id="resultNavBtn">
                <span class="nav-icon">ğŸ“Š</span>
                ê²°ê³¼
            </button>
            <button class="nav-item" id="logoutNavBtn" style="display: none;">
                <span class="nav-icon">ğŸšª</span>
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAxw0xYVu-rvRxOCLInMkqIJeuRIt35qU4",
            authDomain: "ncc2-c4bfa.firebaseapp.com",
            projectId: "ncc2-c4bfa",
            storageBucket: "ncc2-c4bfa.firebasestorage.app",
            messagingSenderId: "386144165760",
            appId: "1:386144165760:web:09492a8eed4a1b710deb65"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('Firebase ì—°ê²° ì™„ë£Œ');

        // ê²Œì„ ìƒíƒœ
        let gameState = {
            isLoggedIn: false,
            player: null,
            role: null,
            secretCode: null,
            results: [],
            isAlive: true,
            deathTimer: null
        };

        // ê¸°ë³¸ ì‹œí¬ë¦¿ ì½”ë“œ
        const tempSecretCodes = {
            'detective': ['DT01', 'DT02', 'DT03'],
            'criminal': ['CR01', 'CR02', 'CR03'],
            'merchant': ['MC01', 'MC02', 'MC03']
        };

        // ì—­í• ë³„ ì„¤ëª…
        const roleDescriptions = {
            detective: {
                title: 'ğŸ” íƒì •',
                description: 'ë²”ì¸ì„ ì°¾ì•„ë‚´ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ì‹œí¬ë¦¿ ì½”ë“œë¥¼ ìˆ˜ì§‘í•˜ì—¬ ë‹¨ì„œë¥¼ ëª¨ìœ¼ì„¸ìš”.',
                className: 'detective'
            },
            criminal: {
                title: 'ğŸ”ª ë²”ì¸',
                description: 'íƒì •ì„ ì°¾ì•„ ì œê±°í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤. ìµœëŒ€ 3ëª…ê¹Œì§€ ì œê±°í•  ìˆ˜ ìˆìœ¼ë©°, íƒì •ì„ ìš°ì„ ì ìœ¼ë¡œ ë…¸ë¦¬ì„¸ìš”.',
                className: 'criminal'
            },
            merchant: {
                title: 'ğŸ’° ìƒì¸',
                description: 'ëˆì„ ë²„ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤. ë‹¤ë¥¸ í”Œë ˆì´ì–´ì™€ ê±°ë˜í•˜ì—¬ ìµœëŒ€í•œ ë§ì€ ëˆì„ ëª¨ìœ¼ì„¸ìš”.',
                className: 'merchant'
            }
        };

        // ì‹œí¬ë¦¿ ì½”ë“œ ìƒì„±
        function generateSecretCode(role) {
            const codes = tempSecretCodes[role];
            return codes[Math.floor(Math.random() * codes.length)];
        }

        // Firebaseì—ì„œ ì‹œí¬ë¦¿ ì½”ë“œ ìƒì„±
        async function generateSecretCodeFromFirebase(role) {
            try {
                const secretCodesDoc = await db.collection('gameSettings').doc('secretCodes').get();
                if (!secretCodesDoc.exists) {
                    return generateSecretCode(role);
                }
                
                const secretCodesData = secretCodesDoc.data();
                const codes = secretCodesData[role] || tempSecretCodes[role];
                
                return codes[Math.floor(Math.random() * codes.length)];
            } catch (error) {
                console.error('ì‹œí¬ë¦¿ ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                return generateSecretCode(role);
            }
        }

        // ë¡œê·¸ì¸ í•¨ìˆ˜
        async function login() {
            console.log('login í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const loginCode = document.getElementById('loginCode').value.toUpperCase();
            const playerName = document.getElementById('playerName').value;
            const playerPosition = document.getElementById('playerPosition').value;

            if (!loginCode || !playerName || !playerPosition) {
                alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loginLoading').style.display = 'block';

            try {
                const codeDoc = await db.collection('loginCodes').doc(loginCode).get();
                
                if (!codeDoc.exists) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ë¡œê·¸ì¸ ì½”ë“œì…ë‹ˆë‹¤.');
                }
                
                const codeData = codeDoc.data();
                
                if (codeData.used) {
                    throw new Error('ì´ë¯¸ ì‚¬ìš©ëœ ë¡œê·¸ì¸ ì½”ë“œì…ë‹ˆë‹¤.');
                }

                const secretCode = await generateSecretCodeFromFirebase(codeData.role);

                const playerData = {
                    name: playerName,
                    position: playerPosition,
                    role: codeData.role,
                    secretCode: secretCode,
                    isAlive: true,
                    results: [],
                    killCount: 0,
                    money: 0,
                    loginTime: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('players').doc(loginCode).set(playerData);

                await db.collection('loginCodes').doc(loginCode).update({
                    used: true,
                    usedBy: playerName,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                gameState.player = {
                    name: playerName,
                    position: playerPosition,
                    loginCode: loginCode
                };
                gameState.role = codeData.role;
                gameState.secretCode = secretCode;
                gameState.isLoggedIn = true;

                setTimeout(() => {
                    document.getElementById('loginLoading').style.display = 'none';
                    
                    // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê¸°
                    document.getElementById('loginScreen').classList.remove('active');
                    document.getElementById('homeScreen').classList.add('active');
                    
                    // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ ë° í™œì„±í™”
                    const bottomNav = document.getElementById('bottomNav');
                    bottomNav.style.display = 'flex';
                    
                    // ëª¨ë“  íƒ­ í™œì„±í™”
                    document.getElementById('roleNavBtn').classList.remove('disabled');
                    document.getElementById('codeInputNavBtn').classList.remove('disabled');
                    document.getElementById('resultNavBtn').classList.remove('disabled');
                    document.getElementById('logoutNavBtn').style.display = 'flex';
                    
                    setupRoleCard();
                    setupResultScreen().catch(error => {
                        console.error('ê²°ê³¼ í™”ë©´ ì„¤ì • ì˜¤ë¥˜:', error);
                    });
                    setupRealtimeListener();
                    
                    console.log('ë¡œê·¸ì¸ ì™„ë£Œ!');
                }, 1000);

            } catch (error) {
                document.getElementById('loginLoading').style.display = 'none';
                alert(error.message);
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì½”ë“œ ì œì¶œ
        async function submitCode() {
            const targetCode = document.getElementById('targetCode').value.toUpperCase();
            
            if (!targetCode) {
                alert('ì‹œí¬ë¦¿ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('codeLoading').style.display = 'block';

            try {
                const playersSnapshot = await db.collection('players')
                    .where('secretCode', '==', targetCode)
                    .get();
                
                if (playersSnapshot.empty) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œí¬ë¦¿ ì½”ë“œì…ë‹ˆë‹¤.');
                }

                const targetPlayerDoc = playersSnapshot.docs[0];
                const targetPlayer = targetPlayerDoc.data();
                const targetPlayerId = targetPlayerDoc.id;

                if (targetPlayerId === gameState.player.loginCode) {
                    throw new Error('ìì‹ ì˜ ì‹œí¬ë¦¿ ì½”ë“œëŠ” ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                if (!targetPlayer.isAlive) {
                    throw new Error('ì´ë¯¸ ê²Œì„ì—ì„œ ì œì™¸ëœ í”Œë ˆì´ì–´ì˜ ì½”ë“œì…ë‹ˆë‹¤.');
                }

                const result = await processSecretCode(targetPlayer, targetPlayerId);
                
                setTimeout(() => {
                    document.getElementById('codeLoading').style.display = 'none';
                    displayCodeResult(result);
                    document.getElementById('targetCode').value = '';
                    setupResultScreen().catch(error => {
                        console.error('ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                    });
                }, 1000);

            } catch (error) {
                document.getElementById('codeLoading').style.display = 'none';
                alert(error.message);
            }
        }

        // ì‹œí¬ë¦¿ ì½”ë“œ ì²˜ë¦¬
        async function processSecretCode(targetPlayer, targetPlayerId) {
            let result = {
                targetCode: targetPlayer.secretCode,
                targetRole: targetPlayer.role,
                targetName: targetPlayer.name,
                targetPlayerId: targetPlayerId,
                timestamp: new Date().toLocaleString('ko-KR')
            };

            const myPlayerId = gameState.player.loginCode;
            const myPlayerDoc = await db.collection('players').doc(myPlayerId).get();
            const myPlayerData = myPlayerDoc.data();

            switch (gameState.role) {
                case 'detective':
                    if (targetPlayer.role === 'merchant') {
                        result.type = 'clue';
                        result.title = 'ìƒì¸ì˜ ì¦ì–¸';
                        result.content = generateMerchantTestimony();
                    } else if (targetPlayer.role === 'criminal') {
                        result.type = 'evidence';
                        result.title = 'ê²°ì •ì  ì¦ê±°';
                        result.content = generateCriminalEvidence();
                    } else {
                        result.type = 'clue';
                        result.title = 'ë™ë£Œ íƒì • ì •ë³´';
                        result.content = 'ë™ë£Œ íƒì •ê³¼ ì •ë³´ë¥¼ ê³µìœ í–ˆìŠµë‹ˆë‹¤.';
                    }
                    break;

                case 'criminal':
                    const currentKillCount = myPlayerData.killCount || 0;
                    
                    if (currentKillCount >= 3) {
                        throw new Error('ì´ë¯¸ ìµœëŒ€ ì œê±° íšŸìˆ˜(3íšŒ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                    }

                    result.type = 'kill';
                    result.title = 'ì œê±° ëŒ€ìƒ í™•ë³´';
                    result.content = `${targetPlayer.name} (${targetPlayer.role === 'detective' ? 'íƒì •' : targetPlayer.role === 'merchant' ? 'ìƒì¸' : 'ëŒ€ìƒ'})ì„ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                    result.canKill = true;
                    result.executed = false;
                    
                    await db.collection('players').doc(myPlayerId).update({
                        killCount: currentKillCount + 1
                    });
                    
                    break;

                case 'merchant':
                    result.type = 'money';
                    if (targetPlayer.role === 'merchant') {
                        result.amount = Math.floor(Math.random() * 100) + 1;
                    } else {
                        result.amount = Math.floor(Math.random() * 100) + 50;
                    }
                    result.title = 'ê±°ë˜ ì„±ê³µ';
                    result.content = `${result.amount}ì›ì„ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    
                    const currentMoney = myPlayerData.money || 0;
                    await db.collection('players').doc(myPlayerId).update({
                        money: currentMoney + result.amount
                    });
                    break;
            }

            await db.collection('players').doc(myPlayerId).update({
                results: firebase.firestore.FieldValue.arrayUnion(result)
            });

            gameState.results.push(result);
            return result;
        }
            let result = {
                targetCode: targetPlayer.secretCode,
                targetRole: targetPlayer.role,
                timestamp: new Date().toLocaleString('ko-KR')
            };

            const myPlayerId = gameState.player.loginCode;
            const myPlayerDoc = await db.collection('players').doc(myPlayerId).get();
            const myPlayerData = myPlayerDoc.data();

            switch (gameState.role) {
                case 'detective':
                    if (targetPlayer.role === 'merchant') {
                        result.type = 'clue';
                        result.title = 'ìƒì¸ì˜ ì¦ì–¸';
                        result.content = generateMerchantTestimony();
                    } else if (targetPlayer.role === 'criminal') {
                        result.type = 'evidence';
                        result.title = 'ê²°ì •ì  ì¦ê±°';
                        result.content = generateCriminalEvidence();
                    } else {
                        result.type = 'clue';
                        result.title = 'ë™ë£Œ íƒì • ì •ë³´';
                        result.content = 'ë™ë£Œ íƒì •ê³¼ ì •ë³´ë¥¼ ê³µìœ í–ˆìŠµë‹ˆë‹¤.';
                    }
                    break;

                case 'criminal':
                    const currentKillCount = myPlayerData.killCount || 0;
                    
                    if (currentKillCount >= 3) {
                        throw new Error('ì´ë¯¸ ìµœëŒ€ ì œê±° íšŸìˆ˜(3íšŒ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                    }

                    result.type = 'kill';
                    result.title = 'ì œê±° ì˜ˆì•½';
                    result.content = `${targetPlayer.role === 'detective' ? 'íƒì •' : targetPlayer.role === 'merchant' ? 'ìƒì¸' : 'ëŒ€ìƒ'}ì„ ì œê±° ì˜ˆì•½í–ˆìŠµë‹ˆë‹¤.`;
                    
                    await db.collection('players').doc(myPlayerId).update({
                        killCount: currentKillCount + 1
                    });

                    setTimeout(async () => {
                        try {
                            await db.collection('players').doc(targetPlayerId).update({
                                isAlive: false,
                                deathTime: firebase.firestore.FieldValue.serverTimestamp(),
                                killedBy: myPlayerId
                            });
                        } catch (error) {
                            console.error('í”Œë ˆì´ì–´ ì œê±° ì˜¤ë¥˜:', error);
                        }
                    }, 180000);
                    
                    break;

                case 'merchant':
                    result.type = 'money';
                    if (targetPlayer.role === 'merchant') {
                        result.amount = Math.floor(Math.random() * 100) + 1;
                    } else {
                        result.amount = Math.floor(Math.random() * 100) + 50;
                    }
                    result.title = 'ê±°ë˜ ì„±ê³µ';
                    result.content = `${result.amount}ì›ì„ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    
                    const currentMoney = myPlayerData.money || 0;
                    await db.collection('players').doc(myPlayerId).update({
                        money: currentMoney + result.amount
                    });
                    break;
            }

            await db.collection('players').doc(myPlayerId).update({
                results: firebase.firestore.FieldValue.arrayUnion(result)
            });

            gameState.results.push(result);
            return result;
        }

        // í™”ë©´ ì „í™˜
        function showScreen(screenName) {
            console.log('í™”ë©´ ì „í™˜:', screenName);
            
            // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // ì„ íƒëœ í™”ë©´ ë³´ì´ê¸°
            const screenMap = {
                'home': 'homeScreen',
                'role': 'roleScreen', 
                'codeInput': 'codeInputScreen',
                'result': 'resultScreen'
            };

            document.getElementById(screenMap[screenName]).classList.add('active');

            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItems = document.querySelectorAll('.nav-item');
            const buttonScreens = ['home', 'role', 'codeInput', 'result'];
            navItems.forEach((button, index) => {
                if (buttonScreens[index] === screenName) {
                    button.classList.add('active');
                }
            });
            
            if (screenName === 'result') {
                setupResultScreen().catch(error => {
                    console.error('ê²°ê³¼ í™”ë©´ ì„¤ì • ì˜¤ë¥˜:', error);
                });
            }
        }

        // ì—­í•  ì¹´ë“œ ì„¤ì •
        function setupRoleCard() {
            const roleInfo = roleDescriptions[gameState.role];
            const roleCard = document.getElementById('roleCard');
            
            roleCard.className = `role-card ${roleInfo.className}`;
            roleCard.innerHTML = `
                <div class="role-title">${roleInfo.title}</div>
                <div class="role-description">${roleInfo.description}</div>
                <div class="secret-code">
                    <div class="secret-code-label">ë‚˜ì˜ ì‹œí¬ë¦¿ ì½”ë“œ</div>
                    <div class="secret-code-value">${gameState.secretCode}</div>
                </div>
            `;

            document.getElementById('myRole').textContent = roleInfo.title;
            document.getElementById('mySecretCode').textContent = gameState.secretCode;
        }

        // ê²°ê³¼ í™”ë©´ ì„¤ì • (ìˆ˜ì •)
        async function setupResultScreen() {
            if (gameState.isLoggedIn) {
                try {
                    const playerDoc = await db.collection('players').doc(gameState.player.loginCode).get();
                    if (playerDoc.exists) {
                        const playerData = playerDoc.data();
                        gameState.results = playerData.results || [];
                    }
                } catch (error) {
                    console.error('ê²°ê³¼ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }

            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            switch (gameState.role) {
                case 'detective':
                    resultTitle.textContent = 'ğŸ” ìˆ˜ì§‘í•œ ë‹¨ì„œë“¤';
                    displayDetectiveResults(resultContent);
                    break;
                case 'criminal':
                    resultTitle.textContent = 'ğŸ”ª ì œê±° ê¸°ë¡';
                    displayCriminalResults(resultContent);
                    break;
                case 'merchant':
                    resultTitle.textContent = 'ğŸ’° ìˆ˜ìµ í˜„í™©';
                    displayMerchantResults(resultContent);
                    break;
            }
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
        function setupRealtimeListener() {
            db.collection('players').doc(gameState.player.loginCode)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        if (!data.isAlive && gameState.isAlive) {
                            gameState.isAlive = false;
                            showDeathMessage();
                        }
                        
                        if (data.results && data.results.length !== gameState.results.length) {
                            gameState.results = data.results;
                            setupResultScreen().catch(error => {
                                console.error('ì‹¤ì‹œê°„ ê²°ê³¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                            });
                        }
                    }
                });
        }

        function showDeathMessage() {
            const gameStatus = document.getElementById('gameStatus');
            gameStatus.innerHTML = `
                <div class="status-message error">
                    âš ï¸ ë²”ì¸ì—ê²Œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤! ê²Œì„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
                </div>
            `;
        }

        function displayCodeResult(result) {
            const resultDiv = document.getElementById('codeResult');
            let html = `
                <div class="status-message">
                    <strong>${result.title}</strong><br>
                    ${result.content}
                </div>
            `;
            resultDiv.innerHTML = html;
        }

        function displayDetectiveResults(container) {
            const clues = gameState.results.filter(r => r.type === 'clue' || r.type === 'evidence');
            
            if (clues.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ì•„ì§ ìˆ˜ì§‘í•œ ë‹¨ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div class="result-list">';
            clues.forEach((clue) => {
                const safeContent = clue.content.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                html += `
                    <div class="result-item" onclick="showClueDetail('${clue.title}', '${safeContent}')">
                        <div class="result-item-title">${clue.title}</div>
                        <div class="result-item-subtitle">${clue.timestamp}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function displayCriminalResults(container) {
            const kills = gameState.results.filter(r => r.type === 'kill');
            const remainingKills = 3 - kills.length;
            
            let html = `
                <div class="status-message">
                    ë‚¨ì€ ì œê±° ê¸°íšŒ: ${remainingKills}íšŒ
                </div>
            `;

            if (kills.length === 0) {
                html += '<p style="text-align: center; color: #666;">ì•„ì§ ì œê±° ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += '<div class="result-list">';
                kills.forEach((kill, index) => {
                    html += `
                        <div class="result-item">
                            <div class="result-item-title">${kill.content}</div>
                            <div class="result-item-subtitle">${kill.timestamp}</div>
                            ${kill.canKill && !kill.executed ? 
                                `<button class="attack-btn" onclick="executeKill(${index})">ê³µê²©</button>` : 
                                kill.executed ? '<span style="color: #e74c3c; position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">ì‹¤í–‰ë¨</span>' : ''
                            }
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function displayMerchantResults(container) {
            const transactions = gameState.results.filter(r => r.type === 'money');
            const totalMoney = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            
            let html = `
                <div class="status-message">
                    ì´ ìˆ˜ìµ: ${totalMoney}ì›
                </div>
            `;

            if (transactions.length === 0) {
                html += '<p style="text-align: center; color: #666;">ì•„ì§ ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += '<div class="result-list">';
                transactions.forEach(transaction => {
                    html += `
                        <div class="result-item">
                            <div class="result-item-title">ê±°ë˜ ì™„ë£Œ</div>
                            <div class="result-item-subtitle">${transaction.timestamp}</div>
                            <div class="result-item-value">+${transaction.amount}ì›</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function showClueDetail(title, content) {
            alert(`${title}\n\n${content}`);
        }

        function generateMerchantTestimony() {
            const testimonies = [
                "ì˜¤ëŠ˜ ì•„ì¹¨ ì‚¬ë¬´ì‹¤ ê·¼ì²˜ì—ì„œ ìˆ˜ìƒí•œ ì‚¬ëŒì„ ë´¤ì–´ìš”.",
                "ì–´ì œ ëŠ¦ê²Œê¹Œì§€ ë‚¨ì•„ìˆë˜ ì‚¬ëŒì´ ìˆì—ˆë˜ ê²ƒ ê°™ì•„ìš”.",
                "ë³µì‚¬ê¸° ê·¼ì²˜ì—ì„œ ì´ìƒí•œ ì†Œë¦¬ê°€ ë‚¬ì–´ìš”.",
                "ëˆ„êµ°ê°€ ë‹¤ë¥¸ ì‚¬ëŒì˜ ì±…ìƒì„ ë’¤ì§€ê³  ìˆì—ˆì–´ìš”.",
                "ì ì‹¬ì‹œê°„ì— í˜¼ì ìˆëŠ” ì‚¬ëŒì„ ë´¤ì–´ìš”.",
                "í™”ì¥ì‹¤ì—ì„œ ìˆ˜ìƒí•œ ëŒ€í™”ë¥¼ ë“¤ì—ˆì–´ìš”."
            ];
            return testimonies[Math.floor(Math.random() * testimonies.length)];
        }

        function generateCriminalEvidence() {
            const evidences = [
                "ë²”ì¸ì€ ì™¼ì†ì¡ì´ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
                "ë²”ì¸ì€ IT ë¶€ì„œì™€ ê´€ë ¨ì´ ìˆì„ ê²ƒì…ë‹ˆë‹¤.",
                "ë²”ì¸ì€ ìµœê·¼ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë§ì´ ë°›ì€ ì‚¬ëŒì…ë‹ˆë‹¤.",
                "ë²”ì¸ì€ íšŒì‚¬ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ì˜ ì•„ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.",
                "ë²”ì¸ì€ í‰ì†Œ ì¡°ìš©í•œ ì„±ê²©ì˜ ì†Œìœ ìì…ë‹ˆë‹¤.",
                "ë²”ì¸ì€ íšŒì‚¬ì— ë¶ˆë§Œì´ ìˆëŠ” ì‚¬ëŒì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤."
            ];
            return evidences[Math.floor(Math.random() * evidences.length)];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('loginButton').addEventListener('click', login);
            document.getElementById('submitCodeButton').addEventListener('click', submitCode);
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('homeNavBtn').addEventListener('click', () => showScreen('home'));
            document.getElementById('roleNavBtn').addEventListener('click', () => showScreen('role'));
            document.getElementById('codeInputNavBtn').addEventListener('click', () => showScreen('codeInput'));
            document.getElementById('resultNavBtn').addEventListener('click', () => showScreen('result'));
            document.getElementById('logoutNavBtn').addEventListener('click', logout);
            
            // ë¡œê·¸ì¸ ì½”ë“œ ì…ë ¥ ì‹œ ìë™ ëŒ€ë¬¸ì ë³€í™˜
            document.getElementById('loginCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
            
            // ì‹œí¬ë¦¿ ì½”ë“œ ì…ë ¥ ì‹œ ìë™ ëŒ€ë¬¸ì ë³€í™˜
            document.getElementById('targetCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
            
            // Enter í‚¤ë¡œ ë¡œê·¸ì¸
            document.getElementById('playerPosition').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Enter í‚¤ë¡œ ì½”ë“œ ì œì¶œ
            document.getElementById('targetCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitCode();
                }
            });

            // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¹€ (ë¡œê·¸ì¸ í›„ í‘œì‹œ)
            document.getElementById('bottomNav').style.display = 'none';
        });
    </script>
</body>
</html>
